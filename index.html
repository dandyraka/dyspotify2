<!DOCTYPE html>
<html lang="id">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Spotify Activity</title>
		<!-- Favicon Spotify multi-size -->
		<link rel="icon" type="image/png" sizes="32x32" href="https://upload.wikimedia.org/wikipedia/commons/1/19/Spotify_logo_without_text.svg">
		<link rel="icon" type="image/png" sizes="16x16" href="https://upload.wikimedia.org/wikipedia/commons/1/19/Spotify_logo_without_text.svg">
		<script src="https://cdn.tailwindcss.com"></script>
		<style>
			@keyframes spin-slow {
				from {
					transform: rotate(0deg);
				}

				to {
					transform: rotate(360deg);
				}
			}

			.spin-slow {
				animation: spin-slow 20s linear infinite;
			}

			.vinyl::before {
				content: "";
				position: absolute;
				top: 50%;
				left: 50%;
				width: 30px;
				height: 30px;
				background: #000;
				border-radius: 50%;
				transform: translate(-50%, -50%);
				z-index: 2;
				box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.2);
			}
		</style>
	</head>
	<body class="bg-[#121212] text-white font-sans p-6 text-center">
		<h1 class="text-2xl font-bold text-[#1db954] mb-10">Spotify Activity</h1>
		<!-- Couple Live -->
		<div id="couple" class="flex justify-center gap-6 mb-12"></div>
		<!-- History -->
		<div id="history" class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
			<div id="pacar-col" class="flex flex-col gap-2"></div>
			<div id="aku-col" class="flex flex-col gap-2"></div>
		</div>
		<script>
			const MY_ID = "spotify:user:dandyraka_";
			const PACAR_ID = "spotify:user:21jq6cmbitks7givwb7zvsyxy";
			let AvatarIMG = {};

			function getInitial(userId) {
				if (userId === PACAR_ID) return "Y";
				if (userId === MY_ID) return "D";
				return "U";
			}

			function timeAgo(timestamp) {
				const ts = String(timestamp).length === 10 ? timestamp * 1000 : timestamp;
				const now = Date.now();
				const diff = Math.floor((now - ts) / 1000);
				if (diff < 60) return "now";
				if (diff < 3600) return `${Math.floor(diff / 60)} m`;
				if (diff < 86400) return `${Math.floor(diff / 3600)} h`;
				if (diff < 604800) return `${Math.floor(diff / 86400)} d`;
				return `${Math.floor(diff / 604800)} w`;
			}

			function spotifyUrl(uri) {
				return "https://open.spotify.com/track/" + uri.split(":")[2];
			}

			function getImage(id) {
				return AvatarIMG[id];
			}
			// Live couple view (fixed: pacar kiri, aku kanan)
			fetch("live.json").then(res => res.json()).then(data => {
				const container = document.getElementById("couple");
				container.innerHTML = "";
				const pacar = (data.friends || []).find(f => f.user.uri === PACAR_ID);
				const aku = (data.friends || []).find(f => f.user.uri === MY_ID);
				AvatarIMG = {
					[pacar.user.uri]: pacar?.user?.imageUrl,
					[aku.user.uri]: aku?.user?.imageUrl
				};

				function renderBuddy(buddy) {
					if (!buddy?.track) return `
							<div class="w-40"></div>`;
					return `
          
							<div class="text-center w-40">
								<div class="font-bold mb-2">${getInitial(buddy.user.uri)}</div>
								<div class="relative w-40 h-40 mx-auto rounded-full overflow-hidden shadow-lg spin-slow vinyl bg-gradient-to-br from-[#222] via-[#111] to-black">
									<img src="${buddy.track?.imageUrl || ""}" class="w-full h-full object-cover rounded-full relative z-10" alt="album art">
									</div>
									<div class="mt-3">
										<a href="${spotifyUrl(buddy.track?.uri)}" target="_blank" class="block text-sm hover:text-[#1db954] transition">
                ${buddy.track?.name || ""} - ${buddy.track?.artist?.name || ""}
              </a>
									</div>
									<div class="text-xs text-gray-400 mt-1">${timeAgo(buddy.timestamp)}</div>
								</div>
        `;
				}
				container.innerHTML = `${renderBuddy(pacar)}${renderBuddy(aku)}`;
			});
			// History (pacar align kanan, aku align kiri)
			fetch("history.json").then(res => res.json()).then(history => {
				const pacar = history.filter(h => h.userId === PACAR_ID).sort((a, b) => b.timestamp - a.timestamp);
				const aku = history.filter(h => h.userId === MY_ID).sort((a, b) => b.timestamp - a.timestamp);
				const container = document.getElementById("history");
				container.innerHTML = `
      
								<div class="col">
									<div id="pacar-col" class="space-y-4"></div>
								</div>
								<div class="col">
									<div id="aku-col" class="space-y-4"></div>
								</div>
    `;
				const pacarCol = document.getElementById("pacar-col");
				const akuCol = document.getElementById("aku-col");

				function createCard(item, isRight) {
					const div = document.createElement("div");
					div.className = `bg-[#1e1e1e] rounded-xl shadow p-3 flex items-center ${isRight ? "justify-end ml-auto" : "justify-start"} space-x-3 w-full sm:max-w-full md:max-w-fit`;
					// Album art + track info dengan jarak
					let content = `
    
								<img src="${item.imageUrl}" class="w-14 h-14 rounded flex-shrink-0 ${isRight ? "ml-3" : "mr-3"}">
									<div class="flex flex-col ${isRight ? "items-end" : "items-start"}">
										<a href="${spotifyUrl(item.uri)}" target="_blank" class="font-medium hover:text-[#1db954] transition truncate max-w-[200px] md:max-w-xs">
        ${item.track} - ${item.artist}
      </a>
										<div class="text-xs text-gray-400 mt-1">${timeAgo(item.timestamp)}</div>
									</div>
  `;
					// Avatar di mobile saja, tanpa nama
					let avatarHtml = `
    
									<div class="md:hidden ${isRight ? "ml-2" : "mr-2"}">
										<img src="${getImage(item.userId)}" class="w-8 h-8 rounded-full">
										</div>
  `;
					div.innerHTML = isRight ? `
										<div class="flex flex-row-reverse items-center">${avatarHtml}${content}</div>` : `
										<div class="flex flex-row items-center">${avatarHtml}${content}</div>`;
					return div;
				}
				pacar.forEach(item => pacarCol.appendChild(createCard(item, true)));
				aku.forEach(item => akuCol.appendChild(createCard(item, false)));
			});
		</script>
	</body>
</html>